{% extends 'base.html' %}

{% load url from future %}

{% block title %}/ {% if g %}{{ g.topic }}{% else %}Create{% endif %}{% endblock %}

{% block content %}
    <script id="add-timeslot-form" type="text/x-handlebars-template">
        <table class="table">
            <thead>
                <tr>
                    <td colspan="2"><strong>Timeslot Information</strong></td>
                </tr>
            </thead>
            <tr>
                <td class="label_cell">
                    <label for="datepicker">Date & Time</label>
                </td>
                <td colspan="3">
                    <div class="input-prepend datepicker">
                        <span class="add-on">Date</span>
                        <input class="datepicker-default" name="datepicker" id="id_datepicker" type="text" />
                    </div>

                    <div class="input-prepend timepicker">
                        <span class="add-on">Time</span>
                        <input class="timepicker-default" name="timepicker" id="id_timepicker" type="text" />
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label_cell">
                    <label for="id_{{ empty_slot.duration.html_name }}">Study Duration</label>
                </td>
                <td>
                    <div class="input-group">
                        {{ empty_slot.duration }}
                        <span class="input-group-addon">mins</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label_cell">
                    <label for="id_{{ empty_slot.compensation.html_name }}">Participant Compensation</label>
                </td>
                <td>
                    <div class="input-group">
                        <span class="input-group-addon">$</span>
                        {{ empty_slot.compensation }}
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label_cell">
                    <label for="id_{{ empty_slot.coop_price.html_name }}">Co-op Price</label>
                </td>
                <td>
                    <div class="input-group">
                        <span class="input-group-addon">$</span>
                        {{ empty_slot.coop_price }}
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label_cell">
                    <label for="id_{{ empty_slot.spots.html_name }}">Spots</label>
                </td>
                <td>
                    <div class="input-group">
                        <span class="input-group-addon">#</span>
                        {{ empty_slot.spots }}
                    </div>
                </td>
            </tr>
            <tr class="total hidden">
                <td>Timeslot Total</td>
                <td class="value"></td>
            </tr>
        </table>
    </script>

    <div class="header row">
        {% if g %}
            <h1 class="col col-lg-8">Editing "{{ g.topic }}"</h1>
        {% else %}
            <h1 class="col col-lg-8">Add new study</h1>
        {% endif %}
        <a class="btn btn-primary btn-large btn-save">Save</a>
    </div>

    <form action="{% if g %}{% url 'edit_study' g.id %}{% else %}{% url 'create_study' %}{% endif %}" id="save_group" method="post">
        {% csrf_token %}
        <table class="table">
            <thead>
                <tr>
                    <td colspan="2"><strong>Study Information</strong></td>
                </tr>
            </thead>
            <tr>
                <td>
                    <label for="id_{{ form.topic.html_name }}">Topic</label>
                </td>
                <td>{{ form.topic }}</td>
            </tr>
            <tr>
                <td>
                    <label for="id_{{ form.venue.html_name }}">Venue</label>
                </td>
                <td>{{ form.venue }}</td>
            </tr>
        </table>

        <table class="table">
            <thead>
                <tr>
                    <td colspan="2"><strong>Timeslots</strong></td>
                </tr>
            </thead>
            <tbody class="calendar"></tbody>
        </table>

        <!-- <table class="table table-striped table-hover table-bordered timeslot-adder">
            <thead>
                <tr >
                    <td colspan="2">
                        <strong>Timeslots</strong>
                        <button class="btn add-timeslot-btn">Add a Timeslot</button>
                    </td>
                </tr>
                {% if timeslots %}
                    {% for t in timeslots %}
                        <tr><td></td><td colspan="2">{{ t.datetime }}</td></tr>
                    {% endfor %}
                {% endif %}
            </thead>
            <tbody>
                <tr class="total hidden">
                    <td>Co-op Total</td>
                    <td class="value"></td>
                </tr>
            </tbody>
            <input type="hidden" name="timeslot_count" id="id_timeslot_count" value="0">
        </table> -->

        <table class="table">
            <tr>
                <td>
                    <label for="id_{{ form.notes.html_name }}">Notes</label>
                </td>
                <td>{{ form.notes }}</td>
            </tr>
        </table>
    </form>
{% endblock %}

{% block scripts %}
    <script type="text/javascript" defer="defer">
        var calendar;

        function calculateTimeslotTotal(elem) {
            var spots = $('.spots', elem).val();
            var price = $('.coop_price', elem).val();

            if (spots > 0 && price > 0)
                return price * spots;
            else return '';
        }

        function calculateCoopTotal() {
            var sum = 0;
            if ($('.timeslot').size() > 1) {
                $('.timeslot').each(function() {
                    sum += parseInt($(this).find('.value strong').last().html());
                });
            }
            return sum;
        }

        $(function() {
            var makeDateTimeSlot = function() {
                $('.datepicker-default').datepicker({
                    autoclose:      true,
                    todayBtn:       true,
                    todayHighlight: true,
                });
                $('.timepicker-default').timepicker();
            }

            var addTimeslot = function() {
                var source   = $('#add-timeslot-form').html();
                var template = Handlebars.compile(source);

                $('.timeslot-adder').before(template);
                var timeslot = $('.timeslot').last();
                //makeDateTimeSlot();
                //numberTimeslotFields($(timeslot), $('.timeslot').size()-1);
                //$('#id_timeslot_count').val(parseInt($('#id_timeslot_count').val())+1);
            }

            var numberElemLabel = function(elem, i) {
                $(elem).parents('td').siblings('.label_cell').children('label')
                    .attr('for', $(elem).attr('id') + '_' + i);
            }

            var numberElemAttr = function(elem, attr, i) {
                var val = $(elem).attr(attr);
                $(elem).attr(attr, val + '_' + i);
            }

            var numberElemAttrsAndLabel = function(elem, attrs, i) {
                numberElemLabel(elem, i);

                for (x in attrs) {
                    numberElemAttr(elem, attrs[x], i);
                }
            }

            var numberTimeslotFields = function(parent, i) {
                if ($('thead tr td strong', parent).html() === 'Timeslot Information')
                    $('thead tr td strong', parent).append(" #" + parseInt(i+1));

                var attrs = ['id', 'name'];

                var strCount = $('.datepicker-default', parent).attr('id').match(/_/g);
                if (strCount.length < 2)
                    numberElemAttrsAndLabel($('.datepicker-default', parent), attrs, i);

                var strCount = $('.timepicker-default', parent).attr('id').match(/_/g);
                if (strCount.length < 2) {
                    numberElemAttr($('.timepicker-default', parent), 'id', i);
                    numberElemAttr($('.timepicker-default', parent), 'name', i);
                }

                numberElemAttrsAndLabel($('#id_duration', parent), attrs, i);
                numberElemAttrsAndLabel($('#id_compensation', parent), attrs, i);
                numberElemAttrsAndLabel($('#id_coop_price', parent), attrs, i);
                numberElemAttrsAndLabel($('#id_spots', parent), attrs, i);
            }
            
            
            var makeEvents = function() {
                var title = "{{ g.topic }}";

                var events = [];
                {% for t in timeslots %}
                    var start = moment("{{ t.datetime.date }} {{ t.datetime.hour }}:{{ t.datetime.minute }}");
                    var end   = start.clone();
                    end.add('minutes', {{ t.duration }});
                    
                    var e = new Object();
                    e.title  = title;
                    e.start  = new Date(start);
                    e.end    = new Date(end);
                    e.allDay = false;

                    events.push(e);
                {% endfor %}

                var e = new Object();
                e.title  = title;
                e.start  = new Date(2013, 05, 30, 12, 0, 0, 0);
                e.end    = new Date(2013, 05, 30, 2, 0, 0, 0);
                e.allDay = false;
                events.push(e);

                return events;
            }

            var buildCalendar = function(calendar) {
                var events = makeEvents();
                console.log(events);

                calendar.fullCalendar({
                    allDaySlot: false,
                    columnFormat: {
                        week: 'ddd M/d'
                    },
                    header: {
                        right: '',
                        left: '',
                    },
                    height: 380,
                    defaultView: 'agendaWeek',
                    editable: true,
                    eventColor: '#e74c3c',
                    events: events,
                    firstDay: 1,
                    minTime: 8,
                    maxTime: 22
                }); 
            }

            calendar = $('.calendar');
            buildCalendar(calendar);

            $('thead .fc-widget-header').each(function(i) {
                if (i > 0 && i < 8) {
                    $(this).html(function(i, el) {
                        var s = el.split(' ');
                        s[1] = '<span>' + s[1] + '</span>';
                        return s.join(' ');
                    });
                }
            });

            $('.fc-agenda-slots th').each(function(i) {
                if (i % 2 == 0) {
                    $(this).html(function(i, el) {
                        //var s = el.substring(el.length - 2, el.length);
                        var s1 = el.slice(0, el.length - 2);
                        s1 = '<span>' + s1 + '</span>';
                        var s2 = el.slice(el.length - 2, el.length);
                        return s1 + s2;
                    });
                }
            });

            {% if not g %}
                addTimeslot();
            {% endif %}

            $('.add-timeslot-btn').click(function() {
                addTimeslot();
                return false;
            });

            $('.timeslot').each(function(i, v) {
                numberTimeslotFields(this, i);
            });

            $('.duration, .datepicker-default').live('focus', function() {
               $('.bootstrap-timepicker').removeClass('open');
               $('.timepicker-default').data("timepicker").open = false;
            });

            $('.spots, .coop_price').live('change', function() {
                var parent = $(this).parents('.timeslot')[0];
                var total = calculateTimeslotTotal(parent);

                if (total !== '') {
                    $(parent).find('.total')
                    .children('.value').html('<strong>$</strong><strong>' + total + '</strong>')
                    .parent().removeClass('hidden');

                    var absTotal = calculateCoopTotal();
                    if (absTotal > 0) {
                        $('.timeslot-adder').find('.total')
                        .children('.value').html('<strong>$' + absTotal + '</strong>')
                        .parent().removeClass('hidden');
                    }
                }
            });
        });
    </script>
{% endblock %}
