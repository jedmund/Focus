{% extends 'base.html' %}

{% load url from future %}

{% block title %}/ {% if g %}{{ g.topic }}{% else %}Create{% endif %}{% endblock %}

{% block content %}
    <script id="add-timeslot-form" type="text/x-handlebars-template">
        <table class="table table-striped table-hover table-bordered timeslot">
            <thead>
                <tr>
                    <td colspan="2"><strong>Timeslot Information</strong></td>
                </tr>
            </thead>
            <tr>
                <td class="label_cell">
                    <label for="datepicker">Date & Time</label>
                </td>
                <td colspan="3">
                    <div class="input-prepend datepicker">
                        <span class="add-on">Date</span>
                        <input class="datepicker-default" id="datepicker" type="text" />
                    </div>

                    <div class="input-prepend timepicker">
                        <span class="add-on">Time</span>
                        <input class="timepicker-default" id="timepicker" type="text" />
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label_cell">
                    <label for="id_{{ empty_slot.duration.html_name }}">Study Duration</label>
                </td>
                <td>
                    <div class="input-append">
                        {{ empty_slot.duration }}
                        <span class="add-on">mins</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label_cell">
                    <label for="id_{{ empty_slot.compensation.html_name }}">Participant Compensation</label>
                </td>
                <td>
                    <div class="input-prepend">
                        <span class="add-on">$</span>
                        {{ empty_slot.compensation }}
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label_cell">
                    <label for="id_{{ empty_slot.coop_price.html_name }}">Co-op Price</label>
                </td>
                <td>
                    <div class="input-prepend">
                        <span class="add-on">$</span>
                        {{ empty_slot.coop_price }}
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label_cell">
                    <label for="id_{{ empty_slot.spots.html_name }}">Spots</label>
                </td>
                <td>
                    <div class="input-prepend">
                        <span class="add-on">#</span>
                        {{ empty_slot.spots }}
                    </div>
                </td>
            </tr>
            <tr class="total hidden">
                <td>Timeslot Total</td>
                <td class="value"></td>
            </tr>
        </table>
    </script>

    <div class="row-fluid">
        {% if g %}
            <h1 class="span8">Editing "{{ g.topic }}"</h1>
        {% else %}
            <h1 class="span8">Add new study</h1>
        {% endif %}
        <a class="btn btn-primary span2 offset2 h1-btn save-btn visible-desktop visible-tablet">Save</a>
    </div>

    <form action="{% if g %}{% url 'edit_study' g.id %}{% else %}{% url 'create_study' %}{% endif %}" id="save_group" method="post">
        {% csrf_token %}
        <table class="table table-striped table-hover table-bordered">
            <thead>
                <tr>
                    <td colspan="2"><strong>Study Information</strong></td>
                </tr>
            </thead>
            <tr>
                <td>
                    <label for="id_{{ form.topic.html_name }}">Topic</label>
                </td>
                <td>{{ form.topic }}</td>
            </tr>
            <tr>
                <td>
                    <label for="id_{{ form.venue.html_name }}">Venue</label>
                </td>
                <td>{{ form.venue }}</td>
            </tr>
        </table>


        <table class="table table-striped table-hover table-bordered timeslot-adder">
            <thead>
                <tr>
                    <td><strong>Timeslots</strong></td>
                    <td><button class="btn add-timeslot-btn">Add a Timeslot</button></td>
                </tr>
            </thead>
            <tbody>
                <tr class="total hidden">
                    <td>Co-op Total</td>
                    <td class="value"></td>
                </tr>
            </tbody>
        </table>

        <table class="table table-striped table-hover table-bordered">
            <tr>
                <td>
                    <label for="id_{{ form.notes.html_name }}">Notes</label>
                </td>
                <td>{{ form.notes }}</td>
            </tr>
        </table>
    </form>
{% endblock %}

{% block scripts %}
    <script type="text/javascript">
        function makeDateTimeSlot() {
            $('.datepicker-default').datepicker({
                autoclose:      true,
                todayBtn:       true,
                todayHighlight: true,
            });
            $('.timepicker-default').timepicker();
        }

        function addTimeslot() {
            var source   = $('#add-timeslot-form').html();
            var template = Handlebars.compile(source);

            $('.timeslot-adder').before(template);
            var timeslot = $('.timeslot').last();

            numberTimeslotIds($(timeslot), $('.timeslot').size()-1);
            makeDateTimeSlot();
        }

        function calculateTimeslotTotal(elem) {
            var spots = $('.spots', elem).val();
            var price = $('.coop_price', elem).val();

            if (spots > 0 && price > 0)
                return price * spots;
            else return '';
        }

        function numberTimeslotIds(elem, i) {
            if ($('thead tr td strong', elem).html() === 'Timeslot Information')
                $('thead tr td strong', elem).append(" #" + parseInt(i+1));

            // Datepicker
            $('#datepicker', elem).parents('td').siblings('.label_cell').children('label')
                .attr('for', $('#datepicker', elem).attr('id') + '_' + i);
            $('#datepicker', elem).attr('id', $('#datepicker', elem).attr('id') + '_' + i);

            // Timepicker
            $('#timepicker', elem).attr('id', $('#timepicker', elem).attr('id') + '_' + i);

            // Study Duration
            $('#id_duration', elem).parents('td').siblings('.label_cell').children('label')
                .attr('for', $('#id_duration', elem).attr('id') + '_' + i);
            $('#id_duration', elem).attr('id', $('#id_duration', elem).attr('id') + '_' + i);

            // Participant Compensation
            $('#id_compensation', elem).parents('td').siblings('.label_cell').children('label')
                .attr('for', $('#id_compensation', elem).attr('id') + '_' + i);
            $('#id_compensation', elem).attr('id', $('#id_compensation', elem).attr('id') + '_' + i);

            // Co-op Price
            $('#id_coop_price', elem).parents('td').siblings('.label_cell').children('label')
                .attr('for', $('#id_coop_price', elem).attr('id') + '_' + i);
            $('#id_coop_price', elem).attr('id', $('#id_coop_price', elem).attr('id') + '_' + i);

            // Spots
            $('#id_spots', elem).parents('td').siblings('.label_cell').children('label')
                .attr('for', $('#id_spots', elem).attr('id') + '_' + i);
            $('#id_spots', elem).attr('id', $('#id_spots', elem).attr('id') + '_' + i);
        }

        function calculateCoopTotal() {
            var sum = 0;
            if ($('.timeslot').size() > 1) {
                $('.timeslot').each(function() {
                    sum += parseInt($(this).find('.value strong').last().html());
                });
            }
            return sum;
        }

        $(function() {
            {% if not g %}
                addTimeslot();
            {% endif %}

            $('.add-timeslot-btn').click(function() {
                addTimeslot();
                return false;
            });

            $('.timeslot').each(function(i, v) {
                numberTimeslotIds(this, i);
            });

            $('.duration, .datepicker-default').live('focus', function() {
               $('.bootstrap-timepicker').removeClass('open');
               $('.timepicker-default').data("timepicker").open = false;
            });

            $('.spots, .coop_price').live('change', function() {
                var parent = $(this).parents('.timeslot')[0];
                var total = calculateTimeslotTotal(parent);

                if (total !== '') {
                    $(parent).find('.total')
                    .children('.value').html('<strong>$</strong><strong>' + total + '</strong>')
                    .parent().removeClass('hidden');

                    var absTotal = calculateCoopTotal();
                    if (absTotal > 0) {
                        $('.timeslot-adder').find('.total')
                        .children('.value').html('<strong>$' + absTotal + '</strong>')
                        .parent().removeClass('hidden');
                    }
                }
            });

        });
    </script>
{% endblock %}